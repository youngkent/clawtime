<!doctype html>
<html lang="en">
  <head>
    <link rel="icon" href="data:," />
    <title>ClawTime</title>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="ClawTime" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script src="https://unpkg.com/@simplewebauthn/browser@13/dist/bundle/index.umd.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <link rel="stylesheet" href="/styles.css?v=20260217a" />
    <script>
      window.CLAWTIME_VERSION = "20260217a";
    </script>
    <script>
      // Fetch and apply avatar theme immediately (before auth)
      fetch("/api/avatar/current")
        .then(function (r) {
          return r.json();
        })
        .then(function (t) {
          console.log("[Theme] Loaded from server:", t);
          window.CLAWTIME_THEME = t;
          if (t.emoji) {
            // Remove old favicon and create new one (defeats aggressive caching)
            var old = document.querySelector('link[rel="icon"]');
            if (old) old.remove();
            var nw = document.createElement("link");
            nw.rel = "icon";
            nw.href =
              "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>" +
              encodeURIComponent(t.emoji) +
              "</text></svg>";
            document.head.appendChild(nw);
            console.log("[Theme] Favicon set to:", t.emoji);
            // Title set by app.js after config loads
            // Update auth emoji if it exists
            var ae = document.getElementById("authEmoji");
            if (ae) ae.textContent = t.emoji;
            var we = document.getElementById("welcomeEmoji");
            if (we) we.textContent = t.emoji;
          }
          if (t.color) document.documentElement.style.setProperty("--accent", "#" + t.color);
        })
        .catch(function (e) {
          console.error("[Theme] Failed to load:", e);
        });
    </script>
  </head>
  <body>
    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
      <div class="big-avatar" id="authEmoji"></div>
      <h2 id="authTitle">ClawTime</h2>
      <p id="authLabel">Checking authentication‚Ä¶</p>
      <button class="auth-btn" id="authBtn" style="display: none">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          style="vertical-align: middle; margin-right: 6px"
        >
          <path
            d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"
          />
        </svg>
        <span id="authBtnText">Sign in with passkey</span>
      </button>
      <div class="auth-error" id="authError"></div>
    </div>

    <!-- Passkeys Modal -->
    <div class="passphrase-modal" id="passkeysModal">
      <div class="passphrase-card" style="max-width: 400px">
        <h3>üîê Passkeys</h3>
        <p class="desc">Manage your registered passkeys for authentication.</p>
        <div id="passkeysList" style="margin-bottom: 16px; text-align: left"></div>
        <div style="display: flex; gap: 8px; justify-content: center">
          <button id="addPasskeyBtn" style="background: var(--accent)">+ Add New</button>
          <button
            id="passkeysClose"
            style="background: var(--surface2); border: 1px solid var(--border)"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Avatar Manager Modal -->
    <div class="passphrase-modal" id="avatarManagerModal">
      <div class="passphrase-card" style="max-width: 500px">
        <h3>üé≠ Avatar Manager</h3>
        <p class="desc">
          Select an avatar to preview it. Click "Use This Avatar" to set as default.
        </p>
        <div
          id="avatarList"
          style="
            margin-bottom: 16px;
            padding: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
            overflow: visible;
          "
        ></div>
        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap">
          <button id="selectAvatarBtn" style="background: var(--accent); display: none">
            ‚úì Use This Avatar
          </button>
          <button
            id="avatarManagerClose"
            style="background: var(--surface2); border: 1px solid var(--border)"
          >
            Close
          </button>
          <!-- Delete button moved to individual avatar cards -->
        </div>
        <p class="desc" style="margin-top: 12px; font-size: 0.75rem">
          To create a new avatar, type "create avatar" in the chat.
        </p>
      </div>
    </div>

    <!-- Chat UI (hidden until auth) -->
    <!-- Task Panel -->
    <div class="task-panel" id="taskPanel">
      <div class="task-panel-inner">
        <div class="task-panel-header">
          <h3>
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 4px"
            >
              <path d="M9 11l3 3L22 4" />
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" />
            </svg>
            Tasks
          </h3>
          <button class="task-panel-close" id="taskPanelClose">‚úï</button>
        </div>
        <div class="task-panel-body" id="taskList"></div>
        <div class="task-panel-footer">
          <button class="task-cancel-btn" id="taskCancel">Close</button>
        </div>
      </div>
    </div>

    <div class="chat-ui" id="chatUi">
      <!-- 3D Avatar Panel (left) -->
      <div class="avatar-panel" id="avatarPanel">
        <div id="avatarCanvas"></div>
        <div class="avatar-flash" id="avatarFlash"></div>
        <div class="avatar-buttons">
          <button class="avatar-action-btn" id="menuBtn" title="Menu">‚ò∞</button>
          <button class="avatar-action-btn" id="taskBtn" title="Task list">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M9 11l3 3L22 4" />
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" /></svg
            ><span class="task-badge" id="taskBadge"></span>
          </button>
        </div>
        <!-- Dropdown menu -->
        <div class="avatar-menu" id="avatarMenu">
          <button class="avatar-menu-item" id="voiceTipBtn">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 4px"
            >
              <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z" />
              <path d="M19 10v2a7 7 0 01-14 0v-2" />
              <line x1="12" y1="19" x2="12" y2="23" />
              <line x1="8" y1="23" x2="16" y2="23" />
            </svg>
            Tap Avatar to Talk
          </button>
          <button class="avatar-menu-item" id="avatarManagerBtn">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 4px"
            >
              <circle cx="12" cy="8" r="5" />
              <path d="M3 21v-2a7 7 0 017-7h4a7 7 0 017 7v2" />
            </svg>
            Manage Avatars
          </button>
          <button class="avatar-menu-item" id="passkeysBtn">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 4px"
            >
              <path
                d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"
              />
            </svg>
            Manage Passkeys
          </button>
          <button class="avatar-menu-item" id="copyUrlBtn">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 4px"
            >
              <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" />
              <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" />
            </svg>
            Copy App URL
          </button>
          <button class="avatar-menu-item" id="logoutBtn">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 4px"
            >
              <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
            Logout
          </button>
        </div>
      </div>

      <!-- Draggable Separator -->
      <div class="drag-separator" id="dragSeparator">
        <div class="drag-handle"><span></span><span></span><span></span></div>
      </div>

      <!-- Chat Main (right) -->
      <div class="chat-main">
        <div class="messages" id="messages" style="position: relative">
          <div class="welcome">
            <div class="big-avatar" id="welcomeEmoji"></div>
            <h2 id="welcomeTitle">ClawTime</h2>
            <p id="welcomeTagline">Your AI assistant. Type a message to start chatting.</p>
          </div>
          <div class="drag-overlay" id="dragOverlay"><span>üìé Drop image here</span></div>

          <!-- File Viewer Overlay -->
          <div class="file-viewer-overlay" id="fileViewer">
            <div class="file-viewer-bar">
              <span class="fv-title" id="fvTitle"></span>
              <button class="fv-btn" id="fvDownload">‚¨á Save</button>
              <button class="fv-btn fv-close" id="fvClose">‚úï Close</button>
            </div>
            <div class="file-viewer-content">
              <iframe id="fvFrame"></iframe>
            </div>
          </div>
        </div>

        <div class="input-area">
          <div class="reply-bar" id="replyBar">
            <div class="reply-bar-content">
              <div class="reply-bar-sender" id="replyBarSender"></div>
              <div class="reply-bar-text" id="replyBarText"></div>
            </div>
            <button class="reply-bar-close" id="replyBarClose">‚úï</button>
          </div>
          <div class="image-preview-bar" id="imagePreview">
            <img id="previewImg" src="" alt="preview" />
            <span class="preview-info" id="previewInfo">image.jpg</span>
            <button class="preview-cancel" id="previewCancel" title="Remove image">‚úï</button>
          </div>
          <div class="input-row">
            <div class="attach-wrap">
              <button class="attach-btn" id="attachBtn" title="Attach">
                <svg
                  width="22"
                  height="22"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"
                  />
                </svg>
              </button>
              <div class="attach-menu" id="attachMenu">
                <button class="attach-menu-item" id="attachFile">
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: middle; margin-right: 6px"
                  >
                    <rect x="3" y="3" width="18" height="18" rx="2" />
                    <circle cx="8.5" cy="8.5" r="1.5" />
                    <path d="M21 15l-5-5L5 21" /></svg
                  >Photo &amp; File
                </button>
                <button class="attach-menu-item" id="attachCamera">
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: middle; margin-right: 6px"
                  >
                    <path
                      d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"
                    />
                    <circle cx="12" cy="13" r="4" /></svg
                  >Camera
                </button>
              </div>
            </div>
            <input type="file" id="fileInput" multiple style="display: none" />
            <input
              type="file"
              id="cameraFileInput"
              accept="image/*"
              capture="environment"
              style="display: none"
            />
            <textarea id="input" rows="1" placeholder="Type a message‚Ä¶"></textarea>
            <button class="send-btn" id="sendBtn" disabled>
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="19" x2="12" y2="5" />
                <polyline points="5 12 12 5 19 12" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Camera Modal -->
        <div class="camera-modal" id="cameraModal">
          <video id="cameraVideo" autoplay playsinline></video>
          <img class="cam-preview-img" id="cameraPreviewImg" alt="captured" />
          <div class="cam-controls" id="cameraControls">
            <button class="cam-ctrl-btn" id="camCloseBtn">‚úï Close</button>
            <button class="cam-ctrl-btn primary" id="camCaptureBtn">üì∏ Capture</button>
          </div>
          <div class="cam-controls" id="cameraReviewControls" style="display: none">
            <button class="cam-ctrl-btn" id="camRetakeBtn">üîÑ Retake</button>
            <button class="cam-ctrl-btn primary" id="camUseBtn">‚úì Use Photo</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Force fresh load: unregister stale service workers
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.getRegistrations().then(function (regs) {
          regs.forEach(function (r) {
            r.unregister();
          });
        });
      }
    </script>
    <script src="/app.js?v=20260219b"></script>

    <!-- 3D Avatar (Three.js) -->
    <script src="/avatar.js?v=20260207r"></script>
  </body>
</html>
